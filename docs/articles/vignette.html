<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>bignlp • bignlp</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="bignlp">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bignlp</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.0.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/vignette.html">bignlp</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>bignlp</h1>
            <h3 class="subtitle">Annotate big corpora</h3>
                        <h4 class="author">Andreas Blaette (<a href="mailto:andreas.blaette@uni-due.de">andreas.blaette@uni-due.de</a>)</h4>
            
            <h4 class="date">2018-07-27</h4>
      
      
      <div class="hidden name"><code>vignette.Rmd</code></div>

    </div>

    
    
<div id="the-rationale-of-the-bignlp-package" class="section level2">
<h2 class="hasAnchor">
<a href="#the-rationale-of-the-bignlp-package" class="anchor"></a>The rationale of the bignlp-package</h2>
<p>There are already a few packages for Natural Language Processing (NLP). These packages are not “pure R” NLP-tools. OpenNLP, coreNLP, or spaCy offer interfaces to standard NLP tools implemented in other programming languages. The cleanNLP R package manages to combine these external tools in one coherent framework. So why yet another NLP R package?</p>
<p>The existing packages are not good at dealing with large volumes of text. The thrust of the bignlp-package is to use a standard tool (Stanford CoreNLP) in parallel mode. To be parsimonious with the memory available, it implements line-by-line processing, so that annotated data is not be kept in memory.</p>
<p>More technically speaking, there are three steps envisaged by in a bignlp workflow:</p>
<ol style="list-style-type: decimal">
<li><p>Input data (XML, for instance) needs to be dissected into a two-column <code>data.table</code> with chunks of text (column “text”) and a chunk id (column “id”). The purpose of the id is to serve as a link to relate chunks with metadata that is stored in another table (and that also has an id column).</p></li>
<li><p>The input <code>data.table</code> is processed in single- or multi-threaded mode, using Stanford CoreNLP. The output of the <code><a href="../reference/corenlp_annotate.html">corenlp_annotate()</a></code>-function is written to one or several NDJSON files (NDJSON stands for newline-delimited JSON). Each line of the NDJSON files is a valid JSON string with the annotation data, and including the id.</p></li>
<li><p>The NDJSON files are processed a line-by-line manner, resulting in a <code>data.table</code> with the chunk ids, and the tokenized and annotated text, of course.</p></li>
</ol>
<p>Before we introduce code for realistic workflows using this approach, we explain the installation requirements.</p>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>At this stage, the bignlp package uses <a href="https://stanfordnlp.github.io/CoreNLP/">Stanford CoreNLP</a>. The CoreNLP code jar and models for specific languages can be downloaded from the project website without restrictions. It is important to have the correct version of Java installed. See the the Stanford CoreNLP project website for further details. To check which Java version is used by R, run the follwing code:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(rJava)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="http://www.rdocumentation.org/packages/rJava/topics/jinit">.jinit</a></span>()</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="http://www.rdocumentation.org/packages/rJava/topics/jcall">.jcall</a></span>(<span class="st">"java/lang/System"</span>, <span class="st">"S"</span>, <span class="st">"getProperty"</span>, <span class="st">"java.runtime.version"</span>)</a></code></pre></div>
<p>The easiest way to download Stanford CoreNLP is to (ab)use the installation mechanism included in the cleanNLP package. In the following example, we will annotate a few documents from the UN General Assembly corpus, so we need the English annotation tools.</p>
<p>Check the presence of the CoreNLP code jar as follows, and perform the download, if necessary.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">library</span>(bignlp)</a></code></pre></div>
<pre><code>## CoreNLP jar directory: /Library/Frameworks/R.framework/Versions/3.5/Resources/library/cleanNLP/extdata/stanford-corenlp-full-2016-10-31</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="cf">if</span> (<span class="kw">getOption</span>(<span class="st">"bignlp.corenlp_dir"</span>) <span class="op">==</span><span class="st"> ""</span>) <span class="kw"><a href="../reference/corenlp_install.html">corenlp_install</a></span>(<span class="dt">lang =</span> <span class="st">"en"</span>)</a></code></pre></div>
<p>Apart from the directory with the code jars, the location of a properties file to configure the annotators is required. Again, use the <code>system.file()</code>-function to find out where that is.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">options</span>(</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  <span class="dt">bignlp.properties_file =</span> <span class="kw">system.file</span>(<span class="dt">package =</span> <span class="st">"cleanNLP"</span>, <span class="st">"extdata"</span>, <span class="st">"StanfordCoreNLP-english-fast.properties"</span>)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">)</a></code></pre></div>
<p>Note that it is not necessary to use cleanNLP for downloading Stanford CoreNLP. CoreNLP and properties files can be stored anywhere on your system, and functions of the bignlp package take the paths as input.</p>
</div>
<div id="preparations-for-text-annotation" class="section level2">
<h2 class="hasAnchor">
<a href="#preparations-for-text-annotation" class="anchor"></a>Preparations for text annotation</h2>
<p>To be able to parallelize the annotation, <em>rJava may not be loaded</em> before initializing the CoreNLP annotator. This is a known <a href="https://github.com/s-u/rJava/issues/25">rJava issue</a>. It is important to consider that other packages may have instantiated a JVM already. The result may be that you cannot assign sufficient memory to the newly instantiated JVMs, the model cannot be loaded, and the process will fail.</p>
<p>There is an unexported function <code>rJava:::.check.JVM()</code> in the rJava package that you may use in an interactive session to check whether the JVM has been initialized already.</p>
<p>The JVMs initialized for tagging in parallel need a lot of memory. With 4GB, you are on the safe side. Set the memory limit for JVMs before doing anything else.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">options</span>(<span class="dt">java.parameters =</span> <span class="st">"-Xmx4g"</span>) <span class="co"># needs to be set before a JVM is initialized.</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">noCores &lt;-<span class="st"> </span>parallel<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/parallel/topics/detectCores">detectCores</a></span>() <span class="op">-</span><span class="st"> </span>2L</a></code></pre></div>
<p>With bignlp, the logic is to write intermediate results to disk, so we do not have to keep everything in memory at a time. So we create the appropriate directory structure before anything else.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">outdir &lt;-<span class="st"> </span><span class="kw">tempdir</span>()</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">tsv_file &lt;-<span class="st"> </span><span class="kw">file.path</span>(outdir, <span class="st">"unga.tsv"</span>)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">ndjson_file &lt;-<span class="st"> </span><span class="kw">file.path</span>(outdir, <span class="st">"unga.ndjson"</span>)</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">tsv_file_tagged &lt;-<span class="st"> </span><span class="kw">file.path</span>(outdir, <span class="st">"unga_tagged.tsv"</span>)</a></code></pre></div>
<p>Finally, we load bignlp.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">packageVersion</span>(<span class="st">"bignlp"</span>)</a></code></pre></div>
<pre><code>## [1] '0.0.4'</code></pre>
<p>The packages we will also need is the <code>data.table</code> package, mostly for its impressively <code>fread</code> and <code>fwrite</code> functions.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">library</span>(data.table)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="kw">library</span>(cwbtools)</a></code></pre></div>
</div>
<div id="example-tagging-the-unga-corpus" class="section level2">
<h2 class="hasAnchor">
<a href="#example-tagging-the-unga-corpus" class="anchor"></a>Example: Tagging the UNGA corpus</h2>
<p>As a first step, we generate a tsv file with the text chunks that shall be processed.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">unga_xml_files &lt;-<span class="st"> </span><span class="kw">list.files</span>(</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  <span class="kw">system.file</span>(<span class="dt">package =</span> <span class="st">"bignlp"</span>, <span class="st">"extdata"</span>, <span class="st">"xml"</span>),</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">  <span class="dt">full.names =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">  )</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">CD &lt;-<span class="st"> </span>CorpusData<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">CD<span class="op">$</span><span class="kw">import_xml</span>(<span class="dt">filenames =</span> unga_xml_files)</a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/fwrite">fwrite</a></span>(<span class="dt">x =</span> CD<span class="op">$</span>chunktable, <span class="dt">file =</span> tsv_file)</a></code></pre></div>
<p>Second, we call the tagger, producing NDJSON output.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">filenames_ndjson &lt;-<span class="st"> </span><span class="kw"><a href="../reference/corenlp_annotate.html">corenlp_annotate</a></span>(<span class="dt">x =</span> tsv_file, <span class="dt">destfile =</span> ndjson_file)</a></code></pre></div>
<pre><code>## Status of the Java Virtual Machine: 0</code></pre>
<pre><code>## Java version: 1.8.0_144-b01</code></pre>
<p>The NDJSON output is parsed into a table …</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">filenames_tsv_tagged &lt;-<span class="st"> </span><span class="kw"><a href="../reference/corenlp_json.html">corenlp_parse_ndjson</a></span>(<span class="dt">x =</span> ndjson_file, <span class="dt">destfile =</span> tsv_file_tagged)</a></code></pre></div>
<p>Finally, let us have a look at the table that is on disk.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">y &lt;-<span class="st"> </span>data.table<span class="op">::</span><span class="kw">fread</span>(tsv_file_tagged)</a></code></pre></div>
<p>This is exactly what we need to fill the <code>tokenstream</code>-slot of our CorpusData object.</p>
<p>The functions are designed to work in a pipe, so we can achieve the same result as follows:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw">library</span>(magrittr)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="kw">library</span>(data.table)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3"></a>
<a class="sourceLine" id="cb17-4" data-line-number="4">dt &lt;-<span class="st"> </span><span class="kw"><a href="../reference/corenlp_annotate.html">corenlp_annotate</a></span>(<span class="dt">x =</span> tsv_file, <span class="dt">destfile =</span> ndjson_file) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="../reference/corenlp_json.html">corenlp_parse_ndjson</a></span>(<span class="dt">destfile =</span> tsv_file_tagged) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6"><span class="st">  </span><span class="kw">lapply</span>(fread) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/rbindlist">rbindlist</a></span>()</a></code></pre></div>
<pre><code>## Status of the Java Virtual Machine: 1</code></pre>
<pre><code>## Java version: 1.8.0_144-b01</code></pre>
</div>
<div id="conclusions" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusions" class="anchor"></a>Conclusions</h2>
<p>Enjoy!</p>
</div>
<div id="appendix-installing-corenlp" class="section level2">
<h2 class="hasAnchor">
<a href="#appendix-installing-corenlp" class="anchor"></a>Appendix: Installing CoreNLP</h2>
</div>
<div id="installing-stanford-corenlp" class="section level2">
<h2 class="hasAnchor">
<a href="#installing-stanford-corenlp" class="anchor"></a>Installing Stanford CoreNLP</h2>
<p>A good and conventional place for installing a tool such as CoreNLP is the /opt dir. So from a terminal, create a directory for CoreNLP, go into it, download the zipped jar files, unzip it, and remove the zip file.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="fu">mkdir</span> /opt/stanford-corenlp</a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="bu">cd</span> /opt/stanford-corenlp</a>
<a class="sourceLine" id="cb20-3" data-line-number="3"><span class="fu">wget</span> http://nlp.stanford.edu/software/stanford-corenlp-full-2017-06-09.zip</a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="fu">unzip</span> stanford-corenlp-full-2017-06-09.zip</a>
<a class="sourceLine" id="cb20-5" data-line-number="5"><span class="fu">rm</span> stanford-corenlp-full-2017-06-09.zip</a></code></pre></div>
<p>In the PolMine Project, we very often work with German data. So we illustrate getting models for a specific language for German. We go into the CoreNLP directory and download the model to this place.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="bu">cd</span> stanford-corenlp-full-2017-06-09</a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="fu">wget</span> http://nlp.stanford.edu/software/stanford-german-corenlp-2017-06-09-models.jar</a></code></pre></div>
<p>The jar file with the model include a default properties file for processing German data. So if you want to configure the parser yourself, you may encounter the problem that this properties file included in the jar will override any other properties file you may want to use. One solution is to extract the properties file from the jar, remove it from the jar and edit it by hand to serve your needs.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="fu">unzip</span> stanford-german-corenlp-2017-06-09-models.jar StanfordCoreNLP-german.properties</a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="fu">mv</span> StanfordCoreNLP-german.properties ..</a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="fu">zip</span> -d stanford-german-corenlp-2017-06-09-models.jar StanfordCoreNLP-german.properties</a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="fu">nano</span> StanfordCoreNLP-german.properties </a></code></pre></div>
<p>Note that the bignlp package already includes a properties file that has been edited for annotating large amounts of data quickly. You will find it as follows:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw">options</span>(<span class="dt">bignlp.properties_file =</span> <span class="kw"><a href="../reference/corenlp_get_properties_file.html">corenlp_get_properties_file</a></span>(<span class="dt">lang =</span> <span class="st">"de"</span>, <span class="dt">fast =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
<p>Again, note that the properties file in the German model jar needs to be removed in the manner described before to make using the handcrafted properties file possible.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#the-rationale-of-the-bignlp-package">The rationale of the bignlp-package</a></li>
      <li><a href="#installation">Installation</a></li>
      <li><a href="#preparations-for-text-annotation">Preparations for text annotation</a></li>
      <li><a href="#example-tagging-the-unga-corpus">Example: Tagging the UNGA corpus</a></li>
      <li><a href="#conclusions">Conclusions</a></li>
      <li><a href="#appendix-installing-corenlp">Appendix: Installing CoreNLP</a></li>
      <li><a href="#installing-stanford-corenlp">Installing Stanford CoreNLP</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Andreas Blaette.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
